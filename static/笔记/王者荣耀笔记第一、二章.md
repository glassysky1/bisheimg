# 初始化项目

创建server文件

CLI全局安装

```shell
cnpm install -g @vue/cli
vue create web
vue create admin
```

## 进入server

//初始化package,json

```shell
cnpm init -y
```

创建index.js

进入package.json

```javascript
"scripts": {
    "serve":"nodemon index.js"
    "test": "echo \"Error: no test specified\" && exit 1"
  },
```

启动服务

```shell
cnpm run serve
```

# 管理后台

## 基于Element UI的后台界面

进入admin

```shell
cnpm run serve
```

安装element（完全引入)

```shell
vue add element
```

添加路由(不要使用history mode)

```shell
vue add router
```

在src/views里面新建Main.vue，把Element布局加进去，并且给路由

所有app.vue不该有的东西去掉

Main.vue的高度为100vh(撑满屏幕)，不要边框

## 创建分类(多层级)

Main

```vue
<template>
  <el-container style="height: 100vh">
    <el-aside width="200px" style="background-color: rgb(238, 241, 246)">
      <el-menu router :default-openeds="['1', '3']">
        <el-submenu index="1">
          <template slot="title">
            <i class="el-icon-message"></i>内容管理
          </template>
          <el-menu-item-group>
            <template slot="title">分类</template>
            <el-menu-item index="/categories/create">新建分类</el-menu-item>
            <el-menu-item index="/categories/list">分类列表</el-menu-item>
          </el-menu-item-group>
        </el-submenu>
      </el-menu>
    </el-aside>
    <el-container>
      <el-header style="text-align: right; font-size: 12px">
        <el-dropdown>
          <i class="el-icon-setting" style="margin-right: 15px"></i>
          <el-dropdown-menu slot="dropdown">
            <el-dropdown-item>查看</el-dropdown-item>
            <el-dropdown-item>新增</el-dropdown-item>
            <el-dropdown-item>删除</el-dropdown-item>
          </el-dropdown-menu>
        </el-dropdown>
        <span>王小虎</span>
      </el-header>

      <el-main>
        <router-view></router-view>
        <!-- <el-table :data="tableData">
          <el-table-column prop="date" label="日期" width="140"></el-table-column>
          <el-table-column prop="name" label="姓名" width="120"></el-table-column>
          <el-table-column prop="address" label="地址"></el-table-column>
        </el-table> -->
      </el-main>
    </el-container>
  </el-container>
</template>

<style>
.el-header {
  background-color: #b3c0d1;
  color: #333;
  line-height: 60px;
}

.el-aside {
  color: #333;
}
</style>

<script>
</script>
```

CategoryEdit

```html
<template>
  <div class="category-edit">
    <h1>新建分类</h1>
    <el-form label-width="120px" @submit.native.prevent="save">
      <el-form-item label="名称">
        <el-input v-model="model.name"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" native-type="submit">保存</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      model: {}
    };
  },
  methods: {
      async save() {
         const res = await this.$http.post('categories',this.model)
      		this.$router.push('/categories/list')
          this.$message({
              type:'success',
              message:'保存成功'
          })
         }
  }
};
</script>

<style>
</style>
```

router.js

```javascript
    path: '/',
    name: 'main',
    component: Main,
    children:[
      {
        path:'/categories/create',
        component:CategoryEdit
      },
       ]
```



### 引入axios

src下新建http.js

```javascript
import axios from "axios";
const http = axios.create({
  baseURL:'http://localhost:3000/admin/api'
})

export default http
```

main.js引入

```javascript
import http from "./http";

Vue.prototype.$http=http
```

后端server

packjson

```javascript
 "scripts": {
    "serve": "nodemon index.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
```

进入serve//cors跨域请求

```shell
cnpm i express@next mongoose cors//跨域
```

routes/admin/index.js(路由)

```javascript
module.exports = app => {
  const express = require('express')
  const router = express.Router()
  const Category = require('../../models/Category')

  router.post('/categories', async (req, res) => {
    const model = await Category.create(req.body)

    res.send(model)
  })

  app.use('/admin/api', router)//子路由挂载上去
}
```

plugins/db.js (数据库连接)

```javascript
module.exports = app =>{
  const mongoose = require('mongoose')
  mongoose.connect('mongodb://127.0.0.1:27017/node-vue-moba',{
    useNewUrlParser:true,
    useUnifiedTopology: true
  })
}
```

models/Category.js

```javascript
const mongoose = require('mongoose')


const schema = new mongoose.Schema({
  name:{
    type:String
  }
})

module.exports = mongoose.model('Category',schema)
```

index.js

```javascript
const express = require("express")

const app = express()

app.use(require('cors')())//跨域
app.use(express.json())

require('./routes/admin')(app)
require('./plugins/db')(app)

app.listen(3000,()=>{
  console.log('http://localhost:3000');
  
})
```

## 分类列表

CategoryList.vue

```vue
<template>
  <div class="category-edit">
    <h1>分类列表</h1>
    <el-table :data="items">
      <el-table-column prop="_id" label="ID" width="230"></el-table-column>
      <el-table-column prop="name" label="分类名称"></el-table-column>
    </el-table>
  </div>
</template>

<script>
export default {
  data() {
    return {
      items:[]
    };
  },
  methods:{
    async fetch(){
      const res = await this.$http.get('categories')
      this.items = res.data
    },
  },
  created(){
    this.fetch()
  }
};
</script>

<style>
</style>
```

index.js

```javascript
  path: '/',
    name: 'main',
    component: Main,
    children:[
      {
        path:'/categories/create',
        component:CategoryEdit
      },
      {
        path:'/categories/list',
        component:CategoryList
      }
    ]
```

server端

server/routes/admin/index.js

```javascript
router.get('/categories',async (req,res) =>{
    const items = await Category.find().limit(10)
    res.send(items)
})
```

## 分类编辑 

CategoryList.vue

```vue
<template>
  <div class="category-edit">
    <h1>分类列表</h1>
    <el-table :data="items">
      <el-table-column prop="_id" label="ID" width="230"></el-table-column>
      <el-table-column prop="name" label="分类名称"></el-table-column>
      <el-table-column
      fixed="right"
      label="操作"
      width="180">
      <!-- slot-scope="scope" -->
      //1
      <template v-slot="scope" >
        <el-button type="primary" size="small" @click="$router.push(`/categories/edit/${scope.row._id}`)">编辑</el-button>
      </template>
    </el-table-column>
    </el-table>
  </div>
</template>

<script>
export default {
  data() {
    return {
      items:[]
    };
  },
  methods:{
    async fetch(){
      const res = await this.$http.get('categories')
      this.items = res.data
    },
  },
  created(){
    this.fetch()
  }
};
</script>

<style>
</style>
```

router.js

```javascript
   path: '/',
    name: 'main',
    component: Main,
    children:[
      {
        path:'/categories/create',
        component:CategoryEdit
      },
      {
          //1
        path:'/categories/edit/:id',
        component:CategoryEdit,
        props:true //把id参数注入到CategoryEdit页面里面
      },
      {
        path:'/categories/list',
        component:CategoryList
      }
    ]
```

CategoryEdit.vue

```vue
<template>
  <div class="category-edit">
    <h1>{{id ? '编辑' : '新建'}}分类</h1>
    <el-form label-width="120px" @submit.native.prevent="save">
      <el-form-item label="名称">
        <el-input v-model="model.name"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" native-type="submit">保存</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      model: {},
    };
  },
  props:{
    id:{
      type:String //竟然可以写可以不写
    }
  },
  methods: {
      //1
   async save() {
     //保存是判断
      let res
      if(this.id){
        //如果是编辑的话
        res = await this.$http.put(`categories/${this.id}`,this.model)

      } else{
        //如果不是编辑的话
        res = await this.$http.post('categories',this.model)
      }
      this.$router.push('/categories/list')
      this.$message({
        type:'success',
        message:'保存成功'
      })
    },
      //1
    async fetch(){
      const res = await this.$http.get(`categories/${this.id}`)
      //太屌了，this.model里面的name和之前的相对应
      this.model =  res.data
    },
  },
  created(){
    this.fetchParents()
    //如果 有this.id说明是编辑状态就获取
      //1
    this.id && this.fetch()
  }
  };
</script>

<style>
</style>
```

server/routes/admin/index.js

```javascript
//如果有id
  router.put('/categories/:id', async (req, res) => {
    //第一个参数是id，第二个是model{}
    const model = await Category.findByIdAndUpdate(req.params.id, req.body)

    res.send(model)
  })
  //如果没有id
  router.post('/categories', async (req, res) => {
    const model = await Category.create(req.body)

    res.send(model)
  })
```



## 分类删除

CategoryList.vue

```vue
<template>
  <div class="category-edit">
    <h1>分类列表</h1>
    <el-table :data="items">
      <el-table-column prop="_id" label="ID" width="230"></el-table-column>
      <el-table-column prop="parent.name" label="上级分类"></el-table-column>
      <el-table-column prop="name" label="分类名称"></el-table-column>
      <el-table-column
      fixed="right"
      label="操作"
      width="180">
      <!-- slot-scope="scope" -->
      
      <template v-slot="scope" >
        <el-button type="primary" size="small" @click="$router.push(`/categories/edit/${scope.row._id}`)">编辑</el-button>
        <!-- 删除一行 -->
          <!-- 1-->
        <el-button type="primary" size="small" @click="remove(scope.row)" >删除 </el-button>
      </template>
    </el-table-column>
    </el-table>
  </div>
</template>

<script>
export default {
  data() {
    return {
      items:[]
    };
  },
  methods:{
    async fetch(){
      const res = await this.$http.get('categories')
      this.items = res.data
    },
      //1
    async remove(row){
     //加一个提示框 
      this.$confirm(`是否确定要删除分类?"${row.name}"`, '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(async () => {
          const res = await  this.$http.delete(`categories/${row._id}`)
          this.fetch()
          this.$message({
            type: 'success',
            message: '删除成功!'
          }); 
        })
    }
  },
  created(){
    this.fetch()
  }
};
</script>

<style>
</style>
```

server/routes/admin/index.js

```javascript
router.delete('/categories/:id',async(req,res)=>{
   	await Category.findByIdAndDelete(req.params.id)
    res.send({
    success:'true'
    })
})
```

## 二级分类(filterable,过滤)

```javascript
const mongoose = require('mongoose')


const schema = new mongoose.Schema({
  name:{type:String},
  //类型是输入里的_id,关联使他本身
    
  parent:{type: mongoose.SchemaTypes.ObjectId,ref:'Category'}
})

module.exports = mongoose.model('Category',schema)

router.get('/categories', async (req, res) => {
    //name:'新闻'这是子
    // parent: { _id: "5dc232963716663a84a7b32d", name: "news", __v: 0 }
    // _id: "5dc232963716663a84a7b32d"
    // name: "news"这是父
    // __v: 0
    const items = await Category.find().populate('parent').limit(10)
    res.send(items)
  })

```

CategoryEdit

```javascript
<template>
  <div class="category-edit">
    <h1>{{id ? '编辑' : '新建'}}分类</h1>
    <el-form label-width="120px" @submit.native.prevent="save">
        <!-- 1 -->
      <el-form-item label="上级分类">
        <el-select filterable v-model="model.parent">
          <!-- 存储的zhi 是_id -->
          <el-option v-for="item in parents" :key="item._id" :label="item.name" :value="item._id" ></el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="名称">
        <el-input v-model="model.name"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" native-type="submit">保存</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      model: {},//里面有parents
      parents:[],
    };
  },
  props:{
    id:{
      type:String //竟然可以写可以不写
    }
  },
  methods: {
   async save() {
     //保存是判断
      let res
      if(this.id){
        //如果是编辑的话
        res = await this.$http.put(`categories/${this.id}`,this.model)

      } else{
        //如果不是编辑的话
        res = await this.$http.post('categories',this.model)
      }
      this.$router.push('/categories/list')
      this.$message({
        type:'success',
        message:'保存成功'
      })
    },
    async fetch(){
      const res = await this.$http.get(`categories/${this.id}`)
      //太屌了，this.model里面的name和之前的相对应
      this.model =  res.data
    },
        //1
    async fetchParents(){
      const res = await this.$http.get(`categories`)
      this.parents = res.data
    }
  },
  created(){
    this.fetchParents()
    //如果 有this.id说明是编辑状态就获取
    this.id && this.fetch()
  }
  };
</script>

<style>
</style>
```

CategoryList

```javascript
<template>
  <div class="category-edit">
    <h1>分类列表</h1>
    <el-table :data="items">
      <el-table-column prop="_id" label="ID" width="230"></el-table-column>
      <el-table-column prop="parent.name" label="上级分类"></el-table-column>
      <el-table-column prop="name" label="分类名称"></el-table-column>
      <el-table-column
      fixed="right"
      label="操作"
      width="180">
      <!-- slot-scope="scope" -->
      
      <template v-slot="scope" >
        <el-button type="primary" size="small" @click="$router.push(`/categories/edit/${scope.row._id}`)">编辑</el-button>
        <!-- 删除一行 -->
        <el-button type="primary" size="small" @click="remove(scope.row)" >删除 </el-button>
      </template>
    </el-table-column>
    </el-table>
  </div>
</template>

<script>
export default {
  data() {
    return {
      items:[]
    };
  },
  methods:{
    async fetch(){
      const res = await this.$http.get('categories')
      this.items = res.data
    },
    async remove(row){
     //加一个提示框 
      this.$confirm(`是否确定要删除分类?"${row.name}"`, '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(async () => {
          const res = await  this.$http.delete(`categories/${row._id}`)
          this.fetch()
          this.$message({
            type: 'success',
            message: '删除成功!'
          }); 
        })
    }
  },
  created(){
    this.fetch()
  }
};
</script>

<style>
</style>
```

## 通用(CRUD 接口)

server/admin/index.js

```javascript
module.exports = app => {
  const express = require('express')
  const router = express.Router({
    mergeParams: true//1,合并参数
  })
  // 这个不需要了
  // const Category = require('../../models/Category')
  //如果没有id
  router.post('/', async (req, res) => {   
    const model = await req.Model.create(req.body)
    res.send(model)
  })
  //如果有id
  router.put('/:id', async (req, res) => {
    //第一个参数是id，第二个是model{}
    const model = await req.Model.findByIdAndUpdate(req.params.id, req.body)

    res.send(model)
  })
  //如果有id
  //删除接口
  router.delete('/:id', async (req, res) => {
    //第一个参数是id，第二个是model{}
     await req.Model.findByIdAndDelete(req.params.id)

    res.send({
      success: true
    })
  })

  router.get('/', async (req, res) => {
    //关联取出
    // parent: { _id: "5dc232963716663a84a7b32d", name: "news", __v: 0 }
    // _id: "5dc232963716663a84a7b32d"
    // name: "news"
    // __v: 0

    //特殊处理
    const queryOptions ={}
    if(req.Model.modelName==='Category'){
      queryOptions.populate = 'parent'
    }
    const items = await req.Model.find().populate(queryOptions).limit(10)

    res.send(items)
  })

  //根据id获取获取详情分类
  router.get('/:id', async (req, res) => {
    const model = await req.Model.findById(req.params.id)
    res.send(model)
  })

  //动态接口
  app.use('/admin/api/rest/:resource', async (req, res, next) => {
    //复数转单数
    const modelName = require('inflection').classify(req.params.resource)
    //请求对象上挂载一个属性
    req.Model = require(`../../models/${modelName}`)
    next()
  }, router)//子路由挂载上去
}

//cnpm i inflection
```

## 装备(物品)管理

serve/models/Item.js

```javascript
const mongoose = require('mongoose')


const schema = new mongoose.Schema({
  name: { type: String },
  icon: { type: String }
})

//中间件
module.exports = mongoose.model('Item', schema)
```

ItemEdit.vue

```vue
<template>
  <div class="category-edit">
    <h1>{{id ? '编辑' : '新建'}}物品</h1>
    <el-form label-width="120px" @submit.native.prevent="save">
      <el-form-item label="名称">
        <el-input v-model="model.name"></el-input>
      </el-form-item>
      <el-form-item label="图标">
        <el-input v-model="model.icon"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" native-type="submit">保存</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      model: {},//里面有parents
    };
  },
  props:{
    id:{
      type:String //竟然可以写可以不写
    }
  },
  methods: {
   async save() {
     //保存是判断
      let res
      if(this.id){
        //如果是编辑的话
        res = await this.$http.put(`rest/items/${this.id}`,this.model)

      } else{
        //如果不是编辑的话
        res = await this.$http.post('rest/items',this.model)
      }
      this.$router.push('/items/list')
      this.$message({
        type:'success',
        message:'保存成功'
      })
    },
    async fetch(){
      const res = await this.$http.get(`rest/items/${this.id}`)
      //太屌了，this.model里面的name和之前的相对应
      this.model =  res.data
    },
  },
  created(){
    //如果 有this.id说明是编辑状态就获取
    this.id && this.fetch()
  }
  };
</script>

<style>
</style>
```

ItemList.vue

```vue
<template>
  <div class="category-edit">
    <h1>物品列表</h1>
    <el-table :data="items">
      <el-table-column prop="_id" label="ID" width="230"></el-table-column>
      <el-table-column prop="name" label="物品名称"></el-table-column>
      <el-table-column
      fixed="right"
      label="操作"
      width="180">
      <!-- slot-scope="scope" -->
      
      <template v-slot="scope" >
        <el-button type="primary" size="small" @click="$router.push(`/items/edit/${scope.row._id}`)">编辑</el-button>
        <!-- 删除一行 -->
        <el-button type="primary" size="small" @click="remove(scope.row)" >删除 </el-button>
      </template>
    </el-table-column>
    </el-table>
  </div>
</template>

<script>
export default {
  data() {
    return {
      items:[]
    };
  },
  methods:{
    async fetch(){
      
      const res = await this.$http.get('/rest/items')
      console.log(res);
      this.items = res.data
    },
    async remove(row){
     //加一个提示框 
      this.$confirm(`是否确定要删除分类?"${row.name}"`, '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(async () => {
          const res = await  this.$http.delete(`/rest/items/${row._id}`)
          this.fetch()
          this.$message({
            type: 'success',
            message: '删除成功!'
          }); 
        })
    }
  },
  created(){
    this.fetch()
  }
};
</script>

<style>
</style>
```

index.js

```javascript
 {
    path: '/',
    name: 'main',
    component: Main,
    children:[
      {
        path:'/categories/create',
        component:CategoryEdit
      },
      {
        path:'/categories/edit/:id',
        component:CategoryEdit,
        props:true //把id参数注入到CategoryEdit页面里面
      },
      {
        path:'/categories/list',
        component:CategoryList
      },
      {
        path:'/items/create',
        component:ItemEdit
      },
      {
        path:'/items/edit/:id',
        component:ItemEdit,
        props:true //把id参数注入到ItemEdit页面里面
      },
      {
        path:'/items/list',
        component:ItemList
      }
    ]
  },
```

## 图片上传

```shell
cnpm i multer
```

server/routes/admin/index.js

```javascript
//最后面
  //multer处理上传文件数据
  const multer = require('multer')
  //传到哪个路径
  const upload = multer({dest: __dirname + '/../../uploads'})
  app.post('/admin/api/upload',upload.single('file'),async (req,res)=>{
   const file =  req.file
   file.url = `http://localhost:3000/uploads/${file.filename}`
   res.send(file)
  })
```

server/index.js

```javascript
//静态文件托管
app.use('/uploads',express.static(__dirname + '/uploads'))

```

ItemEdit.vue

```vue
<template>
  <div class="category-edit">
    <h1>{{id ? '编辑' : '新建'}}物品</h1>
    <el-form label-width="120px" @submit.native.prevent="save">
      <el-form-item label="名称">
        <el-input v-model="model.name"></el-input>
      </el-form-item>
      <el-form-item label="图标">
          <!-- 默认参数 -->
        <el-upload
          class="avatar-uploader"
          :action="$http.defaults.baseURL+'/upload'"
          :show-file-list="false"
          :on-success="afterUpload"
        >
          <img v-if="model.icon" :src="model.icon" class="avatar" />
          <i v-else class="el-icon-plus avatar-uploader-icon"></i>
        </el-upload>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" native-type="submit">保存</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      model: {

      } //里面有parents
    };
  },
  props: {
    id: {
      type: String //竟然可以写可以不写
    }
  },
  methods: {
    //上传成功后返回的参数
    afterUpload(res){
      this.$set(this.model,'icon',res.url)
      // this.model.icon = res.url
      console.log(res);
      
    },
    async save() {
      //保存是判断
      let res;
      if (this.id) {
        //如果是编辑的话
        res = await this.$http.put(`rest/items/${this.id}`, this.model);
      } else {
        //如果不是编辑的话
        res = await this.$http.post("rest/items", this.model);
      }
      this.$router.push("/items/list");
      this.$message({
        type: "success",
        message: "保存成功"
      });
    },
    async fetch() {
      const res = await this.$http.get(`rest/items/${this.id}`);
      //太屌了，this.model里面的name和之前的相对应
      this.model = res.data;
    }
  },
  created() {
    //如果 有this.id说明是编辑状态就获取
    this.id && this.fetch();
  }
};
</script>

```

ItemList.vue

```vue
<template>
  <div class="category-edit">
    <h1>物品列表</h1>
    <el-table :data="items">
      <el-table-column prop="_id" label="ID" width="230"></el-table-column>
      <el-table-column prop="name" label="物品名称"></el-table-column>
      <el-table-column prop="icon" label="图标">
          //1
        <template v-slot = "scope">
          <img :src="scope.row.icon" style="height:3rem;">
        </template>
      </el-table-column>
      <el-table-column
      fixed="right"
      label="操作"
      width="180">
      <!-- slot-scope="scope" -->
      
      <template v-slot="scope" >
        <el-button type="primary" size="small" @click="$router.push(`/items/edit/${scope.row._id}`)">编辑</el-button>
        <!-- 删除一行 -->
        <el-button type="primary" size="small" @click="remove(scope.row)" >删除 </el-button>
      </template>
    </el-table-column>
    </el-table>
  </div>
</template>
```

## 英雄编辑(模型字段)

server/models/Hero.js

```javascript
const mongoose = require('mongoose')


const schema = new mongoose.Schema({
  name: { type: String },
  avatar: { type: String },
  title: { type: String },
  //类别关联着是Category模型
  categories: [{ type: mongoose.SchemaTypes.ObjectId, ref = 'Category' }],
  //综合评分
  scores: {
    //难度
    difficult: { type: Number },
    skills: { type: Number },
    attack: { type: Number },
    survive: { type: Number }
  },
  //技能
  skills: [{
    icon: { type: String },
    name: { type: String },
    description: { type: String },
    tips: { type: String }
  }],
  //顺风出装
  items1: [{ type: mongoose.SchemaTypes.ObjectId, ref: 'Item' }],
  //逆风出装
  items2: [{ type: mongoose.SchemaTypes.ObjectId, ref: 'Item' }],
  //使用技巧
  usageTips:{type:String},
  //对抗技巧
  battleTips:{type:String},
  //团战技巧
  teamTips:{type:String},
  //搭档
  partners:[{
    hero:{type:mongoose.SchemaTypes.ObjectId,ref:'Hero'},
    description:{type:String}
  }]
})

//中间件
module.exports = mongoose.model('Hero', schema)
```

## 英雄编辑(编辑表单)

HeroEdit.vue

```vue
<template>
  <div class="category-edit">
    <h1>{{id ? '编辑' : '新建'}}物品</h1>
    <el-form label-width="120px" @submit.native.prevent="save">
      <el-form-item label="名称">
        <el-input v-model="model.name"></el-input>
      </el-form-item>
      <el-form-item label="称号">
        <el-input v-model="model.title"></el-input>
      </el-form-item>
      <el-form-item label="类型">
        <!-- 多选 -->
        <el-select v-model="model.categories" multiple>
          <el-option
            v-for="item in categories"
            :label="item.name"
            :value="item._id"
            :key="item._id"
          ></el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="难度">
        <!-- 分数 -->
        <el-rate style="margin-top:.6rem" :max="9" show-score v-model="model.scores.difficult"></el-rate>
      </el-form-item>
      <el-form-item label="技能">
        <!-- 分数 -->
        <el-rate style="margin-top:.6rem" :max="9" show-score v-model="model.scores.skills"></el-rate>
      </el-form-item>
      <el-form-item label="攻击">
        <!-- 分数 -->
        <el-rate style="margin-top:.6rem" :max="9" show-score v-model="model.scores.attack"></el-rate>
      </el-form-item>
      <el-form-item label="生存">
        <!-- 分数 -->
        <el-rate style="margin-top:.6rem" :max="9" show-score v-model="model.scores.survive"></el-rate>
      </el-form-item>
      <el-form-item label="头像">
        <!-- 默认参数 -->
        <el-upload
          class="avatar-uploader"
          :action="$http.defaults.baseURL+'/upload'"
          :show-file-list="false"
          :on-success="afterUpload"
        >
          <img v-if="model.avatar" :src="model.avatar" class="avatar" />
          <i v-else class="el-icon-plus avatar-uploader-icon"></i>
        </el-upload>
      </el-form-item>
      <el-form-item label="顺风出装">
        <el-select v-model="model.items1" multiple>
        <el-option v-for="item of items" :key="item._id" :label="item.name" :value="item._id"></el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="逆风出装">
        <el-select v-model="model.items2" multiple>
        <el-option v-for="item of items" :key="item._id" :label="item.name" :value="item._id"></el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="使用技巧">
        <el-input type="textarea" v-model="model.usageTips"></el-input>
      </el-form-item>
      <el-form-item label="对抗技巧">
        <el-input type="textarea" v-model="model.battleTips"></el-input>
      </el-form-item>
      <el-form-item label="团战思路">
        <el-input type="textarea" v-model="model.teamTips"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" native-type="submit">保存</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      items:[],
      categories: [],
      model: {
        name: "",
        avatar: "",
        scores: {
          difficult: 0,
          skills: 0,
          attack: 0,
          survive: 0
        }
      } //里面有parents
    };
  },
  props: {
    id: {
      type: String //竟然可以写可以不写
    }
  },
  methods: {
    //上传成功后返回的参数
    afterUpload(res) {
      // this.$set(this.model,'icon',res.url)
      this.model.avatar = res.url;
      console.log(res);
    },
    async save() {
      //保存是判断
      let res;
      if (this.id) {
        //如果是编辑的话
        res = await this.$http.put(`rest/heroes/${this.id}`, this.model);
      } else {
        //如果不是编辑的话
        res = await this.$http.post("rest/heroes", this.model);
      }
      this.$router.push("/heroes/list");
      this.$message({
        type: "success",
        message: "保存成功"
      });
    },
    async fetch() {
      const res = await this.$http.get(`rest/heroes/${this.id}`);
      //太屌了，this.model里面的name和之前的相对应
      //合并，先把this.model放空对象，再把res.data放空对象
      this.model = Object.assign({}, this.model, res.data);
    },
    async fetchCategories() {
      const res = await this.$http.get(`rest/categories`);

      this.categories = res.data;
    },
    async fetchItems() {
      const res = await this.$http.get(`rest/items`);

      this.items = res.data;
    }
  },
  created() {
    this.fetchCategories();
    //如果 有this.id说明是编辑状态就获取
    this.id && this.fetch();
    this.fetchItems()
  }
};
```

## 技能编辑(加tab栏)

```vue
<template>
  
    <el-form label-width="120px" @submit.native.prevent="save">
      <el-tabs type="border-card" value="skills">
        <el-tab-pane label="基本信息" name="basic">
        </el-tab-pane>
        <el-tab-pane label="技能" name="skills">
          <el-button size="small" @click="model.skills.push({})">
            <i class="el-icon-plus"></i> 添加技能
          </el-button>
          <el-row type="flex" style="flex-wrap:wrap">
            <!-- 一行展示两个 -->
            <el-col :md="12" v-for="(item,index) in model.skills" :key="index">
              <el-form-item label="名称">
                <el-input></el-input>
              </el-form-item>
              <el-form-item label="图标">
                <el-upload
                  class="avatar-uploader"
                  :action="$http.defaults.baseURL+'/upload'"
                  :show-file-list="false"
                  :on-success="afterUpload"
                >
                  <img v-if="item.icon" :src="item.icon" class="avatar" />
                  <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                </el-upload>
              </el-form-item>
              <el-form-item label="描述">
                <el-input v-model="item.description" type="textarea"></el-input>
              </el-form-item>
              <el-form-item label="小提示">
                <el-input v-model="item.tips" type="textarea"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-tab-pane>
      </el-tabs>

      <el-form-item style="margin-top:1rem;">
        <el-button type="primary" native-type="submit">保存</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      items: [],
      categories: [],
      model: {
        name: "",
        avatar: "",
        scores: {
          difficult: 0,
          skills: 0,
          attack: 0,
          survive: 0
        }
      } //里面有parents
    };
  },
  props: {
    id: {
      type: String //竟然可以写可以不写
    }
  },
</script>

```

## 技能编辑(交互，splice)

````vue
    <el-button size="small" @click="model.skills.push({})">
            <i class="el-icon-plus"></i> 添加技能
          </el-button>
          <el-row type="flex" style="flex-wrap:wrap">
            <!-- 一行展示两个 -->
            <el-col :md="12" v-for="(item,index) in model.skills" :key="index">
              <el-form-item label="名称">
                <el-input v-model="item.name"></el-input>
              </el-form-item>
              <el-form-item label="图标">
                //很厉害
                <el-upload
                  class="avatar-uploader"
                  :action="$http.defaults.baseURL+'/upload'"
                  :show-file-list="false"
                  :on-success="res => $set(item,'icon',res.url)"
                >
                  <img v-if="item.icon" :src="item.icon" class="avatar" />
                  <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                </el-upload>
              </el-form-item>
              <el-form-item label="描述">
                <el-input v-model="item.description" type="textarea"></el-input>
              </el-form-item>
              <el-form-item label="小提示">
                <el-input v-model="item.tips" type="textarea"></el-input>
              </el-form-item>
              <el-form-item>
                  //很厉害
                <el-button size="small" type="danger" @click="model.skills.splice(index,1)">删除</el-button>
              </el-form-item>
            </el-col>
          </el-row>
````

## 文章管理

server/models/Article.js

```javascript
const mongoose = require('mongoose')


const schema = new mongoose.Schema({
  categories: [{ type: mongoose.SchemaTypes.ObjectId, ref:'Category' }],
  title:{type:String},
  body:{type:String}
})

//中间件
module.exports = mongoose.model('Article', schema)
```

## 富文本编辑器

在admin

```shell
cnpm i -S vue2-editor
```

```javascript
import {VueEditor} from 'vue2-editor'
```

ArticleEdit.vue

```vue
<template>
  <div class="category-edit">
    <h1>{{id ? '编辑' : '新建'}}文章</h1>
    <el-form label-width="120px" @submit.native.prevent="save">
      <el-form-item label="所属分类">
        <el-select v-model="model.categories" multiple>
          <!-- 存储的zhi 是_id -->
          <el-option
            v-for="item in categories"
            :key="item._id"
            :label="item.name"
            :value="item._id"
          ></el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="标题">
        <el-input v-model="model.title"></el-input>
      </el-form-item>
      <el-form-item label="详情">
        <vue-editor v-model="model.body" useCustomImageHandler @image-added="handleImageAdded"></vue-editor>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" native-type="submit">保存</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
//解构赋值
import { VueEditor } from "vue2-editor";
export default {
  data() {
    return {
      model: {},
      categories: []
    };
  },
  components: {
    VueEditor
  },
  props: {
    id: {
      type: String //竟然可以写可以不写
    }
  },
  methods: {
    //富文本文件上传
    async handleImageAdded(file, Editor, cursorLocation, resetUploader) {
      // An example of using FormData
      // NOTE: Your key could be different such as:
      // formData.append('file', file)
      const formData = new FormData();
      //文件形式上传
      formData.append("file", file);
      const res = await this.$http.post("upload", formData);
      Editor.insertEmbed(cursorLocation, "image", res.data.url);
      resetUploader()
    },
    async save() {
      //保存是判断
      let res;
      if (this.id) {
        //如果是编辑的话
        res = await this.$http.put(`rest/articles/${this.id}`, this.model);
      } else {
        //如果不是编辑的话
        res = await this.$http.post("rest/articles", this.model);
      }
      this.$router.push("/articles/list");
      this.$message({
        type: "success",
        message: "保存成功"
      });
    },
    async fetch() {
      const res = await this.$http.get(`rest/articles/${this.id}`);
      //太屌了，this.model里面的name和之前的相对应
      this.model = res.data;
    },
    async fetchCategories() {
      const res = await this.$http.get(`rest/categories`);
      this.categories = res.data;
    }
  },
  created() {
    this.fetchCategories();
    //如果 有this.id说明是编辑状态就获取
    this.id && this.fetch();
  }
};
</script>

<style>
</style>
```

## 管理员账号管理

```html
      <!-- 默认展开第几个，其他都关闭，点亮是当前路由 -->    
<el-menu router :default-openeds="['1']" unique-opened :default-active="$route.path">

```

server/models/AdminUser.js

```javascript
const mongoose = require('mongoose')

const bcrypt = require('bcryptjs')
const schema = new mongoose.Schema({
  username: { type: String },
  password: { type: String,
    //让编辑界面密码不要被查出来
    select:false,
    set(val){
      //值，第二个是加密强度
      return bcrypt.hashSync(val,10)
    }
  }
})
module.exports = mongoose.model('AdminUser', schema)
```

## 登录校验

server/routes/admin/index.js

```shell
cnpm i jsonwebtoken
```



```javascript
//登录接口
  app.post('/admin/api/login',async(req,res) =>{
    const { username,password} = req.body
    //因为用户名密码直接找是找不到的每次生成的密码是不一样的
    //1根据用户名找用户
    const AdminUser = require('../../models/AdminUser')
    //password是娶不到的，得用select
    const user = await AdminUser.findOne({ username }).select('+password')
    if(!user){
      return res.status(422).send({
        message:'用户不存在'
      })
    }
    //2校验密吗
    const isValid = require('bcryptjs').compareSync(password,user.password)
    //如果密码不对
    if(!isValid){
      return res.status(422).send({
        message:'密码错误'
      })
    }
    
    //3.返回token
    //cnpm i jsonwebtoken
    const jwt = require('jsonwebtoken')
    const token = jwt.sign({id:user._id},app.get('secret'))
    res.send({token})
  })
```

http.js

```javascript
import axios from "axios";
import Vue from "vue";
const http = axios.create({
  baseURL: 'http://localhost:3000/admin/api'
})

//响应拦截
http.interceptors.response.use(res => {
  return res
}, err => {
  //不是200接口，调用element ui 的$message踏出
  if (err.response.data.message) {
    Vue.prototype.$message({
      type: 'error',
      message: err.response.data.message
    })
  }
  return Promise.reject(err)
})
export default http
```

Login.vue

```vue
<template>
  <div class="login-container">
    <el-card header="请先登录" class="login-card">
      <el-form @submit.native.prevent="login">
        <el-form-item label="用户名">
          <el-input v-model="model.username"></el-input>
        </el-form-item>
        <el-form-item label="密码">
          <el-input type="password" v-model="model.password"></el-input>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" native-type="submit">登录</el-button>
        </el-form-item>
      </el-form>
    </el-card>
  </div>
</template>

<script>
export default {
  data(){
    return{
      model:{}
    }
  },
  methods:{
    async login(){
      const res = await this.$http.post('login',this.model)
      //返回token返回到localStorage
      localStorage.token = res.data.token
      this.$router.push('/')
      this.$message({
        type:'success',
        message:'登录成功'
      })
    }
  }
}
</script>

<style lang="stylus" scoped>
.login-card
  width 25rem
  margin 5rem auto 

</style>
```

## 服务端登录校验(jwt)

http.js

```javascript
import axios from "axios";
import Vue from "vue";
const http = axios.create({
  baseURL: 'http://localhost:3000/admin/api'
})

http.interceptors.request.use(config =>{
  // 把token赋值到请求头Authorization(授权信息)，后端去调用
  config.headers.Authorization ='Bearer ' + (localStorage.token || '')
  return config
},error =>{
  return Promise.reject(error);
})

//响应拦截
http.interceptors.response.use(res => {
  return res
}, err => {
  //不是200接口，调用element ui 的$message踏出
  if (err.response.data.message) {
    Vue.prototype.$message({
      type: 'error',
      message: err.response.data.message
    })
  }
  return Promise.reject(err)
})
export default http
```



server/index.js

```javascript
app.set('secret','asdljkgasidog')
```



server/routes/admin/index.js

```javascript
//资源列表
  router.get('/', async (req, res, next) => {
    //获取请求头
    //提取最后一个元素
    const token = String(req.headers.authorization || '').split(' ').pop()
    //解密，把用户id解密出来
    const {id} = jwt.verify(token,app.get('secret'))
    // { id: '5dc782571e185487ec049538', iat: 1573369105 }
    //挂载在req上去
    req.user = await AdminUser.findById(id)
    // { _id: 5dc782571e185487ec049538, username: 'admin', __v: 0 }
    console.log(req.user);
    next()

  }, async (req, res) => {
    //关联取出
    // parent: { _id: "5dc232963716663a84a7b32d", name: "news", __v: 0 }
    // _id: "5dc232963716663a84a7b32d"
    // name: "news"
    // __v: 0

    //特殊处理
    const queryOptions = {}
    if (req.Model.modelName === 'Category') {
      queryOptions.populate = 'parent'
    }
    const items = await req.Model.find().setOptions(queryOptions).limit(10)

    res.send(items)
  })
```

## 服务端登录校验(assert)

```shell
cnpm i http-assert
```

server/routes/admin/index.js

```javascript
  const assert = require('http-assert')
  
  
 //资源列表
  router.get('/', async (req, res, next) => {
    //获取请求头
    //提取最后一个元素
    const token = String(req.headers.authorization || '').split(' ').pop()
    //如果token不存在
    assert(token, 401, '请提供jwt token')
    //解密，把用户id解密出来
    const { id } = jwt.verify(token, app.get('secret'))
    assert(id, 401, '无效的jwt token')
    // { id: '5dc782571e185487ec049538', iat: 1573369105 }
    //挂载在req上去
    req.user = await AdminUser.findById(id)
    // { _id: 5dc782571e185487ec049538, username: 'admin', __v: 0 }
    assert(req.user, 401, '请先登录')
    
    next()

  }, async (req, res) => {
    //关联取出
    // parent: { _id: "5dc232963716663a84a7b32d", name: "news", __v: 0 }
    // _id: "5dc232963716663a84a7b32d"
    // name: "news"
    // __v: 0

    //特殊处理
    const queryOptions = {}
    if (req.Model.modelName === 'Category') {
      queryOptions.populate = 'parent'
    }
    const items = await req.Model.find().setOptions(queryOptions).limit(10)

    res.send(items)
  })


 //登录接口
  app.post('/admin/api/login', async (req, res) => {
    const { username, password } = req.body
    //因为用户名密码直接找是找不到的每次生成的密码是不一样的
    //password是娶不到的，得用select
    const user = await AdminUser.findOne({ username }).select('+password')
    //断言,user用户是否存在，如果不存在抛出422

    assert(user, 422, '用户不存在')
    //2校验密吗
    const isValid = require('bcryptjs').compareSync(password, user.password)
    //如果密码不对
    // if (!isValid) {
    //   return res.status(422).send({
    //     message: '密码错误'
    //   })
    // }
    assert(isValid, 422, '密码错误')
    //3.返回token
    //cnpm i jsonwebtoken
    const token = jwt.sign({ id: user._id }, app.get('secret'))
    res.send({ token })
  })



  //错误处理函数
  app.use(async (err, req, res, next) => {
    //没有状态码就报500错误
    res.status(err.statusCode || 500).send({
      message: err.message
    })
  })
```

http.js

```javascript
import axios from "axios";
import Vue from "vue";
import router from './router'
const http = axios.create({
  baseURL: 'http://localhost:3000/admin/api'
})

http.interceptors.request.use(config => {
  if (localStorage.token) {
    // 把token赋值到请求头Authorization(授权信息)，后端去调用
    config.headers.Authorization = 'Bearer ' + (localStorage.token)
  }
  return config
}, error => {
  return Promise.reject(error);
})

//响应拦截
http.interceptors.response.use(res => {
  return res
}, err => {
  //不是200接口，调用element ui 的$message踏出
  if (err.response.data.message) {
    Vue.prototype.$message({
      type: 'error',
      message: err.response.data.message
    })
  }
  //如果状态码是401，则调回登录页
  if (err.response.status === 401) {
    router.push('/login')
  }
  return Promise.reject(err)
})
export default http
```

## 服务器登录校验(中间件)

server/middleware/auth.js

```javascript
//可以定义
module.exports = options =>{
  return async (req, res, next) => {
    const jwt = require('jsonwebtoken')
    const AdminUser = require('../models/AdminUser')
    const assert = require('http-assert')
    //获取请求头
    //提取最后一个元素
    const token = String(req.headers.authorization || '').split(' ').pop()
    //如果token不存在
    assert(token, 401, '请提供jwt token')
    //解密，把用户id解密出来
    const { id } = jwt.verify(token, req.app.get('secret'))
    assert(id, 401, '无效的jwt token')
    // { id: '5dc782571e185487ec049538', iat: 1573369105 }
    //挂载在req上去
    req.user = await AdminUser.findById(id)
    // { _id: 5dc782571e185487ec049538, username: 'admin', __v: 0 }
    assert(req.user, 401, '请先登录')

    next()
  }
}
```

server/middleware/resuorce.js

```javascript
module.exports = options => async (req, res, next) => {
  //复数转单数
  const modelName = require('inflection').classify(req.params.resource)
  //请求对象上挂载一个属性
  req.Model = require(`../models/${modelName}`)
  next()
}

```

server/routes/admin/index.js

```javascript
//登录校验中间件
  const authMiddleware = require('../../middleware/auth')
  //资源中间件
  const resourceMiddleware = require('../../middleware/resuorce')

  //动态接口
  app.use('/admin/api/rest/:resource', authMiddleware(), resourceMiddleware(), router)//子路由挂载上去


  //multer处理上传文件数据
  const multer = require('multer')
  //传到哪个路径
  const upload = multer({ dest: __dirname + '/../../uploads' })
  app.post('/admin/api/upload',authMiddleware(), upload.single('file'), async (req, res) => {
    const file = req.file
    file.url = `http://localhost:3000/uploads/${file.filename}`
    res.send(file)
  })



```

## 客户端路由限制

router/index.js

```javascript
import Vue from 'vue'
import VueRouter from 'vue-router'
import Main from "../views/Main.vue";
import Login from "../views/Login.vue";
import CategoryEdit from "../views/CategoryEdit.vue";
import CategoryList from "../views/CategoryList.vue";
import ItemEdit from "../views/ItemEdit.vue";
import ItemList from "../views/ItemList.vue";
import HeroEdit from "../views/HeroEdit.vue";
import HeroList from "../views/HeroList.vue";
import ArticleEdit from "../views/ArticleEdit.vue";
import ArticleList from "../views/ArticleList.vue";
import AdEdit from "../views/AdEdit.vue";
import AdList from "../views/AdList.vue";
import AdminUserEdit from "../views/AdminUserEdit.vue";
import AdminUserList from "../views/AdminUserList.vue";
Vue.use(VueRouter)

const routes = [
  { path: '/login', name: 'login', component: Login, meta: { isPublic: true } }
]
const router = new VueRouter({
  routes
})
//跳转路由之前要做什么
//to去哪个页面，from来之哪个页面，next下一步是哪个
router.beforeEach((to,from,next) =>{
  //如果没有isPublic
  if(!to.meta.isPublic && !localStorage.token){
    return next('/login')
  }
  next()
})

export default router

```

## 上传文件的登录校验(el-upload,header)

由于element的el-upload是自带的axios库，所以无法有请求头信息

main.js

```javascript
Vue.mixin({
  computed:{
    uploadUrl(){
      return this.$http.defaults.baseURL + '/upload'
    }
  },
  methods:{
    getAuthHeaders(){
      return{
        Authorization: `Bearer ${localStorage.token || ''}`
      }
    }
  }
})
```

.vue

```vue
    <!-- 默认参数 -->
        <el-upload
          class="avatar-uploader"
          :action="uploadUrl"
          :show-file-list="false"
          :headers ="getAuthHeaders()"
          :on-success="res =>$set(model,'icon',res.url)"
        >
          <img v-if="model.icon" :src="model.icon" class="avatar" />
          <i v-else class="el-icon-plus avatar-uploader-icon"></i>
        </el-upload>
```

